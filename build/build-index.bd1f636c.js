function ConnectionManager(e){this.peer=null,this.connections=new Map,this.playerList=new Map,this.options={debug:0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"}},this.messageHandler=new MessageHandler(this),this.syncStateManager=e}ConnectionManager.prototype.init=function(e,t,n){if(this.peer&&connectionManager.peer._open)return;if(this.peer)return void this.peer.reconnect();this.peer=new Peer(this.options);let o=this;this.peer.on("open",(function(s){console.log("Peer ID is: "+s);let a=new Player(e,t,s);o.playerList.set(s,a),n(a)})),this.peer.on("connection",(function(t){o.connections.set(t.peer,t),o.attachConnectionHandlers(t,e)})),this.peer.on("disconnected",netoworkDisconnect),syncMultiplayerStates=!0;let s=this.syncStateManager;s.onUpdateFinished=function(){o.sendMessage(new Message(MessageType.UPDATE_SYNC_STATE,s.localSyncState))}},ConnectionManager.prototype.connectToHost=function(e,t){let n=this.peer.connect(e);this.connections.set(e,n),this.attachConnectionHandlers(n),n.on("open",t)},ConnectionManager.prototype.attachConnectionHandlers=function(e,t){let n=this;e.on("data",(function(e){n.messageHandler.onMessage(e)})),e.on("close",(function(){n.connections.delete(this.peer),n.playerList.delete(this.peer),updatePlayerList(),t&&n.sendMessage(new Message(MessageType.PLAYER_LIST,new PlayerList(n.playerList)))})),e.on("error",(function(e){console.error(e)}))},ConnectionManager.prototype.sendMessage=function(e){connectionManager.connections.forEach((async(t,n)=>{let o=Promise.reject();for(var s=0;s<5;s++)o=o.catch((()=>{if(!t.open)throw new Error("Connection not open yet");t.send(e.serialize())})).catch((e=>new Promise((function(t,n){setTimeout(n.bind(null,e),500)}))))}))},ConnectionManager.prototype.disconnect=function(){this.connections.forEach((e=>e.close())),this.peer.disconnect(),this.peer=null,this.connections=new Map,this.playerList=new Map,syncMultiplayerStates=!0};var connectionManager=new ConnectionManager(gameSyncState);function MessageHandler(e){this.connectionManager=e}function Message(e,t,n=!0){this.messageType=e,this.data=n?t.serialize():this.typeToPayload(e,t)}MessageHandler.prototype.onMessage=function(e){console.log("Received",e),(e=Message.prototype.deserialize(e)).messageType==MessageType.CLIENT_PLAYER?(this.connectionManager.playerList.set(e.data.peerId,e.data),updatePlayerList(),this.connectionManager.sendMessage(new Message(MessageType.PLAYER_LIST,new PlayerList(this.connectionManager.playerList)))):e.messageType==MessageType.PLAYER_LIST?(this.connectionManager.playerList=e.data.playerList,updatePlayerList()):e.messageType==MessageType.UPDATE_SYNC_STATE&&this.connectionManager.syncStateManager.mergeNewRemoteSyncState(e.data)},Message.prototype.typeToPayload=function(e,t){switch(e){case MessageType.CLIENT_PLAYER:return Player.prototype.deserialize(t);case MessageType.PLAYER_LIST:return PlayerList.prototype.deserialize(t);case MessageType.UPDATE_SYNC_STATE:return SyncState.prototype.deserialize(t)}},Message.prototype.deserialize=function(e){return new Message((e=JSON.parse(e)).messageType,e.data,!1)},Message.prototype.serialize=function(){return JSON.stringify(this)};const MessageType={CLIENT_PLAYER:"CLIENT_PLAYER",PLAYER_LIST:"PLAYER_LIST",UPDATE_SYNC_STATE:"UPDATE_SYNC_STATE"};function Player(e,t,n){this.isHost=e,this.nickname=t,this.peerId=n}function PlayerList(e){this.playerList=e}function connectAsClient(){let e=document.getElementById("networkLinkCode").value;e?(document.getElementById("networkHost").classList.add("hide"),document.getElementById("networkClient").classList.add("hide"),document.getElementById("networkNickname").setAttribute("readonly",""),document.getElementById("networkLinkCode").setAttribute("readonly",""),document.getElementById("networkDisconnect").classList.remove("hide"),connectionManager.init(!1,document.getElementById("networkNickname").value,(t=>onClientConnectionOpened(e,t)))):M.toast({html:"Input Link Code From Host",displayLength:5e3})}function onClientConnectionOpened(e,t){connectionManager.connectToHost(e,(()=>onConnectToHostSuccess(t))),updatePlayerList()}function onConnectToHostSuccess(e){connectionManager.sendMessage(new Message(MessageType.CLIENT_PLAYER,e))}function connectAsHost(){M.toast({html:"Starting Connection...",displayLength:5e3}),connectionManager.init(!0,document.getElementById("networkNickname").value,onHostConnectionOpened),document.getElementById("networkHost").classList.add("hide"),document.getElementById("networkClient").classList.add("hide"),document.getElementById("networkNickname").setAttribute("readonly",""),document.getElementById("networkLinkCode").setAttribute("readonly",""),document.getElementById("networkDisconnect").classList.remove("hide")}function netoworkDisconnect(){document.getElementById("networkHost").classList.remove("hide"),document.getElementById("networkClient").classList.remove("hide"),document.getElementById("networkNickname").removeAttribute("readonly"),document.getElementById("networkLinkCode").removeAttribute("readonly"),document.getElementById("networkDisconnect").classList.add("hide"),connectionManager.disconnect(),updatePlayerList()}function onHostConnectionOpened(e){document.getElementById("networkLinkCode").value=e.peerId,updatePlayerList()}function updatePlayerList(){let e=document.getElementById("playerList");e.innerHTML="",connectionManager.playerList.forEach((t=>{e.appendChild(createPlayerTag(t.nickname,t.isHost))}))}function createPlayerTag(e,t){let n=document.createElement("li");n.classList.add("collection-item"),n.classList.add("avatar"),n.classList.add(t?"host":"client");let o=["#A0CDED","#CDECAD","#FFFAAE","#FFC29F","#F19A9C","#AF8FC1"],s=Math.abs(getHash(e.toUpperCase()))+78,a=o[s%6];o.splice(s%6,1);let i=o[(s+s%7)%5],r=s%4069==998?"shiny/":"";return n.innerHTML="<img class='circle' src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/"+r+s%1009+".png'style='background:linear-gradient(197deg, "+a+"40 0%, "+a+"70 35%, "+i+"96 100%); transform: scale(1.3);outline: solid 1px "+a+";box-shadow: 0 3px 10px rgb(0 0 0 / 41%);'><span>"+e+"<span><p>"+(t?"Hosting":"Connected")+"</p>",n}function toggleLinkCodeVisibility(){let e=document.getElementById("networkLinkCode");e.type="password"==e.type?"text":"password"}function copyLinkCodeToClipboard(){let e=document.getElementById("networkLinkCode");e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value)}Player.prototype.serialize=function(){return JSON.stringify(this)},Player.prototype.deserialize=function(e){return new Player((e=JSON.parse(e)).isHost,e.nickname,e.peerId)},PlayerList.prototype.serialize=function(){return JSON.stringify(Array.from(this.playerList))},PlayerList.prototype.deserialize=function(e){return e=JSON.parse(e),new PlayerList(new Map(e))},SyncState.prototype.serialize=function(){return JSON.stringify(this)},SyncState.prototype.deserialize=function(e){e=JSON.parse(e);let t=new SyncState;return t.badge1=e.badge1,t.badge2=e.badge2,t.badge3=e.badge3,t.badge4=e.badge4,t.badge5=e.badge5,t.badge6=e.badge6,t.badge7=e.badge7,t.badge8=e.badge8,t.hm01=e.hm01,t.hm02=e.hm02,t.hm03=e.hm03,t.hm04=e.hm04,t.hm05=e.hm05,t.hm06=e.hm06,t.hm07=e.hm07,t.hm08=e.hm08,t.magmaEmblem=e.magmaEmblem,t.devonScope=e.devonScope,t.basementKey=e.basementKey,t.storeageKey=e.storeageKey,t.goGoggles=e.goGoggles,t};
//# sourceMappingURL=build-index.bd1f636c.js.map
